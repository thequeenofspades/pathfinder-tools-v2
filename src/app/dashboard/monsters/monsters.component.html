<mat-expansion-panel #monsterFormContainer>
	<mat-expansion-panel-header>
		<mat-panel-title>
			New Monster
		</mat-panel-title>
		<mat-panel-description>
			Add new monster(s) directly to initiative
		</mat-panel-description>
	</mat-expansion-panel-header>
	<app-monster-form
		(onSubmitted)="add($event); monsterFormContainer.close()"
		(onCanceled)="monsterFormContainer.close()"></app-monster-form>
</mat-expansion-panel>
<mat-expansion-panel #encounterFormContainer>
	<mat-expansion-panel-header>
		<mat-panel-title>
			New Encounter
		</mat-panel-title>
		<mat-panel-description>
			Create a new encounter
		</mat-panel-description>
	</mat-expansion-panel-header>
	<app-encounter-form
		(onSubmitted)="encounterService.newEncounter($event); encounterFormContainer.close()"
		(onCanceled)="encounterFormContainer.close()"></app-encounter-form>
</mat-expansion-panel>
<div class="container" fxLayout="row wrap" fxLayoutAlign="center start" fxLayout.xs="column">
	<mat-card *ngFor="let encounter of encounterService.encounters$ | async" class="player-card" fxFlex="1 0 500px">
		<mat-card-title>
			{{encounter.name}}
			<ng-container *ngIf="!encounter.new && !encounter.edit">
				<button mat-icon-button matTooltip="New Monster" (click)="encounter.new = true"><mat-icon svgIcon="plus"></mat-icon></button>
				<button mat-icon-button matTooltip="Edit" (click)="encounter.edit = true"><mat-icon svgIcon="pencil"></mat-icon></button>
				<button mat-icon-button matTooltip="Remove" (click)="encounterService.removeEncounter(encounter)"><mat-icon>delete</mat-icon></button>
			</ng-container>
		</mat-card-title>
		<mat-card-content>
			<ng-container *ngIf="!encounter.new && !encounter.edit">
				<mat-accordion>
					<mat-expansion-panel *ngFor="let monster of encounter.monsters">
						<mat-expansion-panel-header>
							<mat-panel-title>
								{{monster.name}} <ng-container *ngIf="monster.quantity > 1">({{ monster.idx }} of {{ monster.quantity }})</ng-container>
							</mat-panel-title>
							<mat-panel-description>
								Details
							</mat-panel-description>
						</mat-expansion-panel-header>
						<ng-container *ngIf="!monster.edit">
							HP: {{monster.hp}}<br>
							Constitution: {{monster.conScore}}<br>
							Initiative: <ng-container *ngIf="monster.initiativeBonus >= 0">+</ng-container>{{monster.initiativeBonus}}<br>
							Perception: <ng-container *ngIf="monster.perceptionBonus >= 0">+</ng-container>{{monster.perceptionBonus}}
							<span matBadge="{{monster.notification.perception}}" matBadgeColor="accent" [matBadgeHidden]="!monster.notification.perception">
								<button mat-icon-button color="primary" matTooltip="Roll" (click)="rollPerception(monster)">
									<mat-icon svgIcon="dice-d20"></mat-icon>
								</button>
							</span>
							<mat-action-row>
								<button mat-button (click)="monster.edit=true">Edit</button>
								<button mat-button color="primary" (click)="initiativeService.add(monster)">Add to Initiative</button>
								<button mat-button color="warn" (click)="encounterService.removeFromEncounter(monster, encounter)">Remove</button>
							</mat-action-row>
						</ng-container>
						<ng-container *ngIf="monster.edit">
							<app-monster-form
								[model]="monster"
								(onSubmitted)="encounterService.update(encounter, monster, $event); monster.edit=false"
								(onCanceled)="monster.edit=false">
							</app-monster-form>
						</ng-container>
					</mat-expansion-panel>
				</mat-accordion>
			</ng-container>
			<ng-container *ngIf="encounter.new && !encounter.edit">
				<app-monster-form
					(onSubmitted)="add($event, encounter); encounter.new = false"
					(onCanceled)="encounter.new = false">
				</app-monster-form>
			</ng-container>
			<ng-container *ngIf="encounter.edit && !encounter.new">
				<app-encounter-form
					(onSubmitted)="encounterService.rename(encounter, $event); encounter.edit=false"
					(onCanceled)="encounter.edit=false"></app-encounter-form>
			</ng-container>
		</mat-card-content>
		<mat-card-actions *ngIf="!encounter.new && !encounter.edit">
			<button mat-button color="primary" (click)="encounterService.addEncounterToInitiative(encounter)" [disabled]="!encounter.monsters.length">Add to Initiative</button>
		</mat-card-actions>
	</mat-card>
</div>